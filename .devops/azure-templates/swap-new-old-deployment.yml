parameters:
  - name: "DO_DEPLOY"
    type: boolean
  - name: "ENV"
    type: string
  - name: "NEW_VERSION"
    type: string
  - name: "APP_NAME"
    type: string
  - name: "KUBERNETES_SERVICE_CONN"
    type: string
  - name: "NAMESPACE"
    type: string
  - name: "VALUE_FILE"
    type: string
  - name: "HELM_NEW_RELEASE_FILTER"
    type: string
  - name: "CHART_TYPE"
    type: string
    #optional parameters
    default: "filepath"
  - name: "CHART_PATH"
    type: string
    default: "helm"
  - name: "DO_BLUE_GREEN_DEPLOY"
    type: boolean
    default: false
  - name: "WAIT_FOR_EXECUTION"
    type: boolean
    default: true
  - name: "ARGUMENTS"
    type: string
    default: "--timeout 5m0s"
  - name: "BLUE_VERSION"
    type: string
    default: "none"
steps:

  # STEP 0: retrieve current release version from helm release
  - task: HelmDeploy@0
    displayName: List event dispatcher releases
    name: helm_event_dispatcher_releases
    inputs:
      kubernetesServiceEndpoint: ${{ parameters.KUBERNETES_SERVICE_CONN }}
      namespace: ${{ parameters.NAMESPACE }}
      command: ls
      arguments: --filter ${{ parameters.HELM_NEW_RELEASE_FILTER }} --output json
  - task: Bash@3
    name: helm_chart_version
    displayName: 'Retrieve helm chart version associated to helm release'
    inputs:
      targetType: "inline"
      script: |
        version=$(echo '$(helm_event_dispatcher_releases.helmOutput)' | yq '.[].chart' | sed -e 's/pagopa-ecommerce-event-dispatcher-//g')
        echo "##vso[task.setvariable variable=helm_current_release_version;isOutput=true]$version"
      failOnStderr: false

  # STEP 1: Checkout currently deployed version tag
  - script: |
      checkoutVersion=$(helm_chart_version.helm_current_release_version)
      echo "Checkout current version repo tag: [$checkoutVersion]" 
      git checkout $checkoutVersion
    displayName: 'Checkout currently deployed source code tag'
  # STEP 2: override the old release with the current version (for rollback purpose)
  - task: HelmDeploy@0
    condition: and(succeeded(), eq(${{ parameters.DO_DEPLOY }}, True))
    displayName: Deploy current PROD version $(helm_chart_version.helm_current_release_version) as OLD release
    inputs:
      kubernetesServiceEndpoint: ${{ parameters.KUBERNETES_SERVICE_CONN }}
      namespace: ${{ parameters.NAMESPACE }}
      command: upgrade
      chartType: ${{ parameters.CHART_TYPE }}
      chartPath: ${{ parameters.CHART_PATH }}
      chartName: ${{ parameters.APP_NAME }}-old
      releaseName: ${{ parameters.APP_NAME }}-old
      valueFile: ${{ parameters.VALUE_FILE }}
      install: true
      waitForExecution: ${{ parameters.WAIT_FOR_EXECUTION }}
      arguments: ${{ parameters.ARGUMENTS }}
      overrideValues: microservice-chart.ingress.path=/pagopa-ecommerce-event-dispatcher-old/(.*),microservice-chart.envConfig.DEPLOYMENT_VERSION=old,microservice-chart.canaryDelivery.create=${{ parameters.DO_BLUE_GREEN_DEPLOY }},microservice-chart.canaryDelivery.deployment.image.tag=${{ parameters.BLUE_VERSION }}

  # STEP 3: enable OLD receivers and stop new ones
  - task: Bash@3
    name: start_old_stop_new_receivers
    displayName: 'Perform curl to start old receivers and stop new ones'
    inputs:
      targetType: "inline"
      script: |
        declare -A commandUrls=( ["DEV"]="https://weudev.ecommerce.internal.dev.platform.pagopa.it/pagopa-ecommerce-event-dispatcher-old/event-dispatcher/event-receivers/commands" ["UAT"]="https://weuuat.ecommerce.internal.uat.platform.pagopa.it/pagopa-ecommerce-event-dispatcher-old/event-dispatcher/event-receivers/commands" ["PROD"]="https://weuprod.ecommerce.internal.platform.pagopa.it/pagopa-ecommerce-event-dispatcher-old/event-dispatcher/event-receivers/commands")
        commandUrl=${commandUrls[${{ parameters.ENV }}]}
        echo $commandUrl
        curl --location $commandUrl \
        --header 'Content-Type: application/json' \
        --data '{
          "command": "START",
          "deploymentVersion": "OLD"
        }'
        curl --location $commandUrl \
        --header 'Content-Type: application/json' \
        --data '{
          "command": "STOP",
          "deploymentVersion": "NEW"
        }'
      failOnStderr: false

  # STEP 4: perform checkout against the new version release tag
  - script: |
      checkoutVersion=${{ parameters.NEW_VERSION }} 
      echo "Checkout new release version repo tag: [$checkoutVersion]" 
      git checkout $checkoutVersion
    displayName: 'Checkout new release version tag'

  #TODO inserire step di approve manuale per far cominciare il deploy della nuova versione solo una volta che i receivers sono effettivamente stoppati sulla verisone NEW
  # STEP 5: override the new release with the new version (the new released version)
  - task: HelmDeploy@0
    displayName: Deploy new version as NEW release
    inputs:
      kubernetesServiceEndpoint: ${{ parameters.KUBERNETES_SERVICE_CONN }}
      namespace: ${{ parameters.NAMESPACE }}
      command: upgrade
      chartType: ${{ parameters.CHART_TYPE }}
      chartPath: ${{ parameters.CHART_PATH }}
      chartName: ${{ parameters.APP_NAME }}-new
      releaseName: ${{ parameters.APP_NAME }}-new
      valueFile: ${{ parameters.VALUE_FILE }}
      install: true
      waitForExecution: ${{ parameters.WAIT_FOR_EXECUTION }}
      arguments: ${{ parameters.ARGUMENTS }}
      overrideValues: microservice-chart.ingress.path=/pagopa-ecommerce-event-dispatcher-new/(.*),microservice-chart.envConfig.DEPLOYMENT_VERSION=new,microservice-chart.canaryDelivery.create=${{ parameters.DO_BLUE_GREEN_DEPLOY }},microservice-chart.canaryDelivery.deployment.image.tag=${{ parameters.BLUE_VERSION }}

  # STEP 5: once new version is deployed, proceed to stop old receivers (new receivers are already started)
  - task: Bash@3
    name: start_new_stop_old_receivers
    displayName: 'Perform curl to stop old receivers and start new ones'
    inputs:
      targetType: "inline"
      script: |
        declare -A commandUrls=( ["DEV"]="https://api.dev.platform.pagopa.it/pagopa-ecommerce-event-dispatcher/event-dispatcher/event-receivers/commands" ["UAT"]="https://weuuat.ecommerce.internal.uat.platform.pagopa.it/pagopa-ecommerce-event-dispatcher-new/event-dispatcher/event-receivers/commands" ["PROD"]="https://weuprod.ecommerce.internal.platform.pagopa.it/pagopa-ecommerce-event-dispatcher-new/event-dispatcher/event-receivers/commands")
        commandUrl=${commandUrls[${{ parameters.ENV }}]}
        echo $commandUrl
        curl --location $commandUrl \
        --header 'Content-Type: application/json' \
        --data '{
          "command": "STOP",
          "deploymentVersion": "OLD"
        }'
        curl --location $commandUrl \
        --header 'Content-Type: application/json' \
        --data '{
          "command": "START",
          "deploymentVersion": "NEW"
        }'
      failOnStderr: false
